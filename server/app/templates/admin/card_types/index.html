{% extends "admin/layout.html" %}
{% set active_page = "license-types" %}
{% set page_title = "卡密类型" %}
{% set page_subtitle = "管理类型模板、默认策略与视觉标签" %}

{% block title %}卡密类型管理 - 授权后台{% endblock %}

{% block head_extra %}
<style>
    .type-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
    }
    .type-grid {
        display: grid;
        grid-template-columns: minmax(320px, 360px) 1fr;
        gap: 28px;
    }
    .checkbox-row {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--text-secondary);
    }
    textarea {
        min-height: 96px;
        resize: vertical;
    }
    .badge-inactive {
        background: rgba(239, 68, 68, 0.12);
        color: var(--danger);
    }
    .color-chip {
        width: 18px;
        height: 18px;
        border-radius: 6px;
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .inline-form {
        display: inline;
    }
</style>
{% endblock %}

{% block topbar_actions %}
<a class="secondary-btn" href="/admin/licenses">返回卡密列表</a>
{% endblock %}

{% block content %}
{% set return_to = request.url.path + ('?' + request.url.query if request.url.query else '') %}

<section class="type-stats">
    <div class="stat-card">
        <div class="stat-title">类型总数</div>
        <div class="stat-value">{{ total }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">启用中</div>
        <div class="stat-value">{{ total_active }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">已停用</div>
        <div class="stat-value">{{ total_inactive }}</div>
    </div>
</section>

<div class="type-grid">
    <section class="panel">
        {% if edit_type %}
        <h2>编辑卡密类型</h2>
        <form method="post" action="/admin/license-types/{{ edit_type.id }}/update">
            <input type="hidden" name="return_to" value="{{ return_to }}" />
            <div>
                <label>标识 (不可修改)</label>
                <input type="text" value="{{ edit_type.code }}" disabled />
            </div>
            <div>
                <label>显示名称</label>
                <input type="text" name="display_name" value="{{ edit_type.display_name }}" maxlength="64" required />
            </div>
            <div>
                <label>默认有效期（天）</label>
                <input type="number" name="default_duration_days" min="0" max="3650" value="{{ edit_type.default_duration_days if edit_type.default_duration_days is not none else '' }}" />
            </div>
            <div>
                <label>默认前缀</label>
                <input type="text" name="card_prefix" maxlength="16" value="{{ edit_type.card_prefix or '' }}" />
            </div>
            <div>
                <label>颜色（Hex）</label>
                <input type="text" name="color" maxlength="16" value="{{ edit_type.color or '' }}" placeholder="#2563eb" />
            </div>
            <div>
                <label>排序值</label>
                <input type="number" name="sort_order" min="0" max="1000" value="{{ edit_type.sort_order }}" />
            </div>
            <div>
                <label>描述</label>
                <textarea name="description" maxlength="500">{{ edit_type.description or '' }}</textarea>
            </div>
            <label class="checkbox-row">
                <input type="checkbox" name="is_active" {% if edit_type.is_active %}checked{% endif %} /> 启用该类型
            </label>
            <div style="display:flex; gap:12px;">
                <button class="primary-btn" type="submit">保存修改</button>
                <a class="secondary-btn" href="/admin/license-types">取消</a>
            </div>
        </form>
        {% else %}
        <h2>新增卡密类型</h2>
        <form method="post" action="/admin/license-types/create">
            <input type="hidden" name="return_to" value="{{ return_to }}" />
            <div>
                <label>类型标识（slug，小写字母/数字/短横线）</label>
                <input type="text" name="code" maxlength="32" placeholder="例如：month" required />
            </div>
            <div>
                <label>显示名称</label>
                <input type="text" name="display_name" maxlength="64" placeholder="月卡" required />
            </div>
            <div>
                <label>默认有效期（天）</label>
                <input type="number" name="default_duration_days" min="0" max="3650" placeholder="例如：30" />
            </div>
            <div>
                <label>默认前缀</label>
                <input type="text" name="card_prefix" maxlength="16" placeholder="如：VIP" />
            </div>
            <div>
                <label>颜色（Hex）</label>
                <input type="text" name="color" maxlength="16" placeholder="#2563eb" />
            </div>
            <div>
                <label>排序值</label>
                <input type="number" name="sort_order" min="0" max="1000" value="{{ total + 1 }}" />
            </div>
            <div>
                <label>描述</label>
                <textarea name="description" maxlength="500" placeholder="用于说明类型特性、权益等"></textarea>
            </div>
            <label class="checkbox-row">
                <input type="checkbox" name="is_active" checked /> 启用该类型
            </label>
            <button class="primary-btn" type="submit">创建类型</button>
        </form>
        {% endif %}
    </section>

    <section class="panel">
        <h2>类型列表</h2>
        <table>
            <thead>
                <tr>
                    <th style="width:140px;">显示名称</th>
                    <th>标识</th>
                    <th>默认有效期</th>
                    <th>前缀</th>
                    <th>颜色</th>
                    <th>状态</th>
                    <th>卡密数量</th>
                    <th style="width:200px;">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for row in card_types %}
                <tr>
                    <td>{{ row.type.display_name }}</td>
                    <td>{{ row.type.code }}</td>
                    <td>{{ row.type.default_duration_days if row.type.default_duration_days is not none else '不限' }} 天</td>
                    <td>{{ row.type.card_prefix or '-' }}</td>
                    <td>
                        {% if row.type.color %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                            <rect x="0" y="0" width="18" height="18" rx="6" ry="6" fill="{{ row.type.color }}" stroke="rgba(15, 23, 42, 0.08)" stroke-width="1" />
                        </svg>
                        {% else %}
                        <span class="badge badge-muted">默认</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if row.type.is_active %}
                        <span class="badge badge-active">启用</span>
                        {% else %}
                        <span class="badge badge-inactive">停用</span>
                        {% endif %}
                    </td>
                    <td>{{ row.license_count }}</td>
                    <td>
                        <div class="actions">
                            <a class="link-btn" href="/admin/license-types?edit={{ row.type.id }}">编辑</a>
                            <form class="inline-form" method="post" action="/admin/license-types/{{ row.type.id }}/toggle">
                                <input type="hidden" name="return_to" value="{{ return_to }}" />
                                <button class="secondary-btn" type="submit">{% if row.type.is_active %}停用{% else %}启用{% endif %}</button>
                            </form>
                            <form class="inline-form" method="post" action="/admin/license-types/{{ row.type.id }}/delete" onsubmit="return confirm('删除后无法恢复，确认删除 {{ row.type.display_name }} 类型？');">
                                <input type="hidden" name="return_to" value="{{ return_to }}" />
                                <button class="danger-btn" type="submit">删除</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
</div>
{% endblock %}
