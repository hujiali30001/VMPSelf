{% extends "admin/layout.html" %}
{% set active_page = "settings" %}
{% set page_title = "系统设置" %}
{% set page_subtitle = "维护后台管理员账号与关键配置。" %}

{% block title %}系统设置 - 授权管理后台{% endblock %}

{% block head_extra %}
<style>
    .settings-grid {
        display: grid;
        grid-template-columns: minmax(320px, 360px) 1fr;
        gap: 28px;
        align-items: start;
    }
    .config-card {
        border-radius: 18px;
        padding: 20px;
        background: var(--bg-panel);
        border: 1px solid rgba(37, 99, 235, 0.12);
        box-shadow: var(--shadow-soft);
    }
    .config-card h3 {
        margin: 0 0 12px;
        font-size: 16px;
    }
    .config-meta {
        font-size: 13px;
        color: var(--text-secondary);
        display: grid;
        gap: 10px;
    }
    .admins-table td {
        vertical-align: middle;
    }
    .admin-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .audit-panel h2 {
        margin-bottom: 12px;
    }
    .audit-meta {
        font-size: 13px;
        color: var(--text-secondary);
    }
    .audit-filter-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        margin-bottom: 16px;
    }
    .audit-filter-field {
        display: flex;
        flex-direction: column;
    }
    .audit-filter-field label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }
    .audit-filter-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    .audit-table {
        width: 100%;
        border-collapse: collapse;
    }
    .audit-table th,
    .audit-table td {
        padding: 12px 14px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        vertical-align: top;
    }
    .audit-table th {
        text-align: left;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
    }
    .audit-table td small {
        display: block;
        color: var(--text-secondary);
        margin-top: 6px;
    }
    .audit-payload {
        font-family: var(--font-mono);
        font-size: 12px;
        background: rgba(15, 23, 42, 0.04);
        border-radius: 10px;
        padding: 8px 10px;
        margin-top: 6px;
        max-height: 120px;
        overflow: auto;
        white-space: pre-wrap;
    }
    .audit-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-top: 16px;
        flex-wrap: wrap;
    }
    .audit-pagination-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .audit-pagination form {
        display: inline-flex;
        gap: 6px;
        align-items: center;
    }
    .audit-pagination button {
        padding: 8px 14px;
    }
    .access-grid {
        display: grid;
        gap: 24px;
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    }
    .access-card {
        border-radius: 18px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: var(--bg-panel);
        padding: 20px;
        box-shadow: var(--shadow-soft);
    }
    .access-card h3 {
        margin: 0 0 12px;
        font-size: 16px;
    }
    .access-meta {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        line-height: 1.6;
    }
    .access-list {
        margin: 0 0 14px;
        padding-left: 18px;
        font-size: 13px;
    }
    .access-list li {
        margin-bottom: 4px;
    }
    .form-note {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 6px;
    }
    @media (max-width: 1080px) {
        .settings-grid {
            grid-template-columns: 1fr;
        }
        .audit-filter-grid {
            grid-template-columns: 1fr;
        }
        .access-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block topbar_actions %}
<div class="admin-actions">
    <span class="badge badge-info">管理员 {{ admins|length }} 人</span>
    <span class="badge badge-positive">超级管理员 {{ super_admin.username }}</span>
</div>
{% endblock %}

{% block content %}
{% set return_to = request.url.path + ('?' + request.url.query if request.url.query else '') %}

<div class="settings-grid">
    <section class="panel">
        <h2>新增后台管理员</h2>
        <form class="form-grid" method="post" action="/admin/settings/admins">
            <div class="full-row">
                <label>用户名</label>
                <input type="text" name="username" placeholder="至少 3 个字符" required minlength="3" />
            </div>
            <div class="full-row">
                <label>角色</label>
                <select name="role" required>
                    {% for role in roles %}
                        <option value="{{ role.code }}" {% if role.code == 'admin' %}selected{% endif %}>{{ role.display_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="full-row">
                <label>密码</label>
                <input type="password" name="password" placeholder="至少 8 位" required minlength="8" />
            </div>
            <div class="full-row">
                <label>确认密码</label>
                <input type="password" name="confirm_password" placeholder="再次输入" required minlength="8" />
            </div>
            <input type="hidden" name="return_to" value="{{ return_to }}" />
            <div class="full-row">
                <button class="primary-btn" type="submit">创建管理员</button>
            </div>
        </form>
    </section>

    <section class="panel">
        <h2>系统信息</h2>
        <div class="config-card">
            <h3>内置管理员</h3>
            <div class="config-meta">
                <div>用户名：<strong>{{ super_admin.username }}</strong></div>
                <div>说明：该账号来源于环境配置文件，无法在此处修改密码。</div>
                <div>如需禁用，可在配置文件中调整账号信息。</div>
            </div>
        </div>
        <div class="config-card" style="margin-top: 16px;">
            <h3>运行参数</h3>
            <div class="config-meta">
                <div>发版版本：{{ admin_version }}</div>
                <div>静态资源：使用系统内置样式，无需额外配置。</div>
            </div>
        </div>
    </section>
</div>

<section class="panel">
    <h2>管理员列表</h2>
    {% if admins %}
    <table class="admins-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>角色</th>
                <th>状态</th>
                <th>最近登录</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for admin in admins %}
            <tr>
                <td>{{ admin.id }}</td>
                <td>{{ admin.username }}</td>
                <td>{{ admin.role.display_name if admin.role else '-' }}</td>
                <td>
                    {% if admin.is_active %}
                        <span class="badge badge-positive">启用</span>
                    {% else %}
                        <span class="badge badge-muted">停用</span>
                    {% endif %}
                </td>
                <td>{{ admin.last_login_at.isoformat() if admin.last_login_at else '-' }}</td>
                <td>{{ admin.created_at.isoformat() }}</td>
                <td>
                    <div class="admin-actions">
                        <details>
                            <summary class="secondary-btn" style="cursor: pointer;">重置密码</summary>
                            <form class="form-grid" method="post" action="/admin/settings/admins/{{ admin.id }}/password" style="margin-top: 10px;">
                                <div class="full-row">
                                    <input type="password" name="password" placeholder="新密码" required minlength="8" />
                                </div>
                                <div class="full-row">
                                    <input type="password" name="confirm_password" placeholder="确认密码" required minlength="8" />
                                </div>
                                <input type="hidden" name="return_to" value="{{ return_to }}" />
                                <div class="full-row">
                                    <button class="primary-btn" type="submit">保存</button>
                                </div>
                            </form>
                        </details>
                        <form method="post" action="/admin/settings/admins/{{ admin.id }}/status">
                            <input type="hidden" name="return_to" value="{{ return_to }}" />
                            {% if admin.is_active %}
                            <input type="hidden" name="is_active" value="false" />
                            <button class="danger-btn" type="submit" {% if admin.username == super_admin.username %}disabled{% endif %}>停用</button>
                            {% else %}
                            <input type="hidden" name="is_active" value="true" />
                            <button class="secondary-btn" type="submit">启用</button>
                            {% endif %}
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">暂无数据库管理员，右上方可创建新的后台账号。</div>
    {% endif %}
</section>

<section class="panel">
    <h2>访问控制</h2>
    <p class="intro-text">在此配置 CDN 边缘与主服务的 IP 访问名单。支持填写单个 IP（如 203.0.113.10）以及 CIDR 网段（如 203.0.113.0/24）。</p>
    <div class="access-grid">
        <div class="access-card">
            <h3>CDN 边缘访问白名单</h3>
            <div class="access-meta">
                <div>实时解析的自动白名单：
                    {% if access_cdn_auto_whitelist %}
                        <ul class="access-list">
                            {% for ip in access_cdn_auto_whitelist %}
                                <li>{{ ip }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="form-note">暂无自动记录。添加 CDN 节点时会自动补充。</div>
                    {% endif %}
                </div>
            </div>
            <form method="post" action="/admin/settings/access/cdn/whitelist" class="form-grid">
                <div class="full-row">
                    <label>手动追加 IP / 网段</label>
                    <textarea name="entries" rows="6" placeholder="每行一个 IP 或 CIDR，支持逗号分隔">{% if access_cdn_manual_whitelist %}{{ access_cdn_manual_whitelist | join('\n') }}{% endif %}</textarea>
                    <p class="form-note">这些记录会与自动解析结果合并，共同生效。</p>
                </div>
                <input type="hidden" name="return_to" value="{{ return_to }}" />
                <div class="full-row">
                    <button type="submit" class="primary-btn">保存白名单</button>
                </div>
            </form>
        </div>
        <div class="access-card">
            <h3>CDN 边缘访问黑名单</h3>
            <div class="access-meta">
                <div>当前共享密钥请求头：<strong>{{ access_cdn_ip_header or 'X-Forwarded-For' }}</strong></div>
            </div>
            <form method="post" action="/admin/settings/access/cdn/blacklist" class="form-grid">
                <div class="full-row">
                    <label>禁止访问的 IP / 网段</label>
                    <textarea name="entries" rows="6" placeholder="支持单个 IP 与 CIDR">{% if access_cdn_blacklist %}{{ access_cdn_blacklist | join('\n') }}{% endif %}</textarea>
                    <p class="form-note">命中黑名单的请求会直接拒绝，即便已通过共享密钥验证。</p>
                </div>
                <input type="hidden" name="return_to" value="{{ return_to }}" />
                <div class="full-row">
                    <button type="submit" class="secondary-btn">保存黑名单</button>
                </div>
            </form>
        </div>
        <div class="access-card">
            <h3>主服务访问白名单</h3>
            <div class="access-meta">
                <div>来源 IP 读取顺序：
                    {% if access_core_ip_header %}
                        优先使用请求头 <strong>{{ access_core_ip_header }}</strong>
                    {% else %}
                        使用客户端连接 IP
                    {% endif %}
                </div>
            </div>
            <form method="post" action="/admin/settings/access/core/whitelist" class="form-grid">
                <div class="full-row">
                    <label>允许访问的 IP / 网段</label>
                    <textarea name="entries" rows="6" placeholder="留空则不启用白名单">{% if access_core_whitelist %}{{ access_core_whitelist | join('\n') }}{% endif %}</textarea>
                    <p class="form-note">当配置白名单后，未匹配的请求将被拒绝。</p>
                </div>
                <input type="hidden" name="return_to" value="{{ return_to }}" />
                <div class="full-row">
                    <button type="submit" class="primary-btn">保存白名单</button>
                </div>
            </form>
        </div>
        <div class="access-card">
            <h3>主服务访问黑名单</h3>
            <form method="post" action="/admin/settings/access/core/blacklist" class="form-grid">
                <div class="full-row">
                    <label>禁止访问的 IP / 网段</label>
                    <textarea name="entries" rows="6" placeholder="留空表示不使用黑名单">{% if access_core_blacklist %}{{ access_core_blacklist | join('\n') }}{% endif %}</textarea>
                    <p class="form-note">与白名单一起使用时，黑名单优先级更高。</p>
                </div>
                <input type="hidden" name="return_to" value="{{ return_to }}" />
                <div class="full-row">
                    <button type="submit" class="secondary-btn">保存黑名单</button>
                </div>
            </form>
        </div>
    </div>
</section>

<section class="panel audit-panel">
    <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
        <h2>审计日志</h2>
        <div class="audit-meta">共 {{ audit_pagination.total }} 条记录 · 第 {{ audit_pagination.page }} / {{ audit_pagination.total_pages }} 页</div>
    </div>

    <form class="audit-filter-grid" method="get">
        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="page_size" value="{{ audit_pagination.page_size }}" />
        <div class="audit-filter-field">
            <label for="filter-module">模块</label>
            <select id="filter-module" name="module">
                <option value="">全部模块</option>
                {% for option in audit_module_options %}
                    <option value="{{ option }}" {% if audit_filters.module == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="audit-filter-field">
            <label for="filter-action">操作</label>
            <input id="filter-action" type="text" name="action" value="{{ audit_filters.action or '' }}" placeholder="如 create / update" />
        </div>
        <div class="audit-filter-field">
            <label for="filter-actor-type">操作者类型</label>
            <select id="filter-actor-type" name="actor_type">
                <option value="">全部类型</option>
                {% for option in audit_actor_type_options %}
                    <option value="{{ option }}" {% if audit_filters.actor_type == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="audit-filter-field">
            <label for="filter-actor-role">操作者角色</label>
            <input id="filter-actor-role" type="text" name="actor_role" value="{{ audit_filters.actor_role or '' }}" placeholder="如 admin" />
        </div>
        <div class="audit-filter-field">
            <label for="filter-actor-id">操作者 ID</label>
            <input id="filter-actor-id" type="number" name="actor_id" value="{{ audit_filters.actor_id or '' }}" min="0" />
        </div>
        <div class="audit-filter-field">
            <label for="filter-target-type">目标类型</label>
            <select id="filter-target-type" name="target_type">
                <option value="">全部类型</option>
                {% for option in audit_target_type_options %}
                    <option value="{{ option }}" {% if audit_filters.target_type == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="audit-filter-field">
            <label for="filter-target-id">目标 ID</label>
            <input id="filter-target-id" type="text" name="target_id" value="{{ audit_filters.target_id or '' }}" />
        </div>
        <div class="audit-filter-field">
            <label for="filter-license-id">关联卡密 ID</label>
            <input id="filter-license-id" type="number" name="license_id" value="{{ audit_filters.license_id or '' }}" min="0" />
        </div>
        <div class="audit-filter-field">
            <label for="filter-request-id">请求 ID</label>
            <input id="filter-request-id" type="text" name="request_id" value="{{ audit_filters.request_id or '' }}" placeholder="按 request_id 精确匹配" />
        </div>
        <div class="audit-filter-field">
            <label for="filter-start">开始时间</label>
            <input id="filter-start" type="datetime-local" name="start" value="{{ audit_filters.start or audit_start_value or '' }}" />
        </div>
        <div class="audit-filter-field">
            <label for="filter-end">结束时间</label>
            <input id="filter-end" type="datetime-local" name="end" value="{{ audit_filters.end or audit_end_value or '' }}" />
        </div>
        <div class="audit-filter-field">
            <label for="filter-search">关键字</label>
            <input id="filter-search" type="text" name="q" value="{{ audit_filters.search or '' }}" placeholder="搜索消息 / 操作者" />
        </div>
        <div class="audit-filter-actions">
            <button class="primary-btn" type="submit">筛选</button>
            <a class="secondary-btn" href="/admin/settings">重置</a>
            <button class="secondary-btn" type="submit" formmethod="get" formaction="/admin/settings/audit/export">导出 CSV</button>
        </div>
    </form>

    {% if audit_logs %}
    <div class="table-responsive">
        <table class="audit-table">
            <thead>
                <tr>
                    <th>时间</th>
                    <th>模块 · 操作</th>
                    <th>消息</th>
                    <th>操作者</th>
                    <th>目标</th>
                    <th>请求信息</th>
                </tr>
            </thead>
            <tbody>
                {% for log in audit_logs %}
                <tr>
                    <td>
                        {{ log.created_at.isoformat() }}
                        {% if log.request_id %}
                        <small>请求 ID：{{ log.request_id }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ log.module or 'general' }} · {{ log.action or 'unknown' }}</strong>
                        {% if log.event_type and log.event_type != log.action %}
                        <small>类型：{{ log.event_type }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {{ log.message or '-' }}
                        {% if log.payload %}
                        <div class="audit-payload">{{ log.payload | tojson(indent=2) }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {{ log.actor_name or '-' }}
                        <small>
                            类型：{{ log.actor_type or 'unknown' }}
                            {% if log.actor_role %}· 角色：{{ log.actor_role }}{% endif %}
                            {% if log.actor_id is not none %}· ID：{{ log.actor_id }}{% endif %}
                        </small>
                    </td>
                    <td>
                        {{ log.target_name or '-' }}
                        <small>
                            类型：{{ log.target_type or 'unknown' }}
                            {% if log.target_id %}· ID：{{ log.target_id }}{% endif %}
                        </small>
                    </td>
                    <td>
                        {% if log.ip_address %}
                        <div>IP：{{ log.ip_address }}</div>
                        {% endif %}
                        {% if log.license_id %}
                        <small>关联卡密 ID：{{ log.license_id }}</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="audit-pagination">
        <div>共 {{ audit_pagination.total }} 条数据，当前显示第 {{ audit_pagination.page }} 页</div>
        <div class="audit-pagination-controls">
            <form method="get">
                {% for key, value in audit_filters.items() %}
                    {% if value is not none and value != '' %}
                        {% set field_name = key %}
                        {% if key == 'search' %}{% set field_name = 'q' %}{% endif %}
                        <input type="hidden" name="{{ field_name }}" value="{{ value }}" />
                    {% endif %}
                {% endfor %}
                <input type="hidden" name="page_size" value="{{ audit_pagination.page_size }}" />
                <input type="hidden" name="page" value="{{ audit_pagination.prev_page }}" />
                <button class="secondary-btn" type="submit" {% if not audit_pagination.has_prev %}disabled{% endif %}>上一页</button>
            </form>
            <form method="get">
                {% for key, value in audit_filters.items() %}
                    {% if value is not none and value != '' %}
                        {% set field_name = key %}
                        {% if key == 'search' %}{% set field_name = 'q' %}{% endif %}
                        <input type="hidden" name="{{ field_name }}" value="{{ value }}" />
                    {% endif %}
                {% endfor %}
                <input type="hidden" name="page_size" value="{{ audit_pagination.page_size }}" />
                <input type="hidden" name="page" value="{{ audit_pagination.next_page }}" />
                <button class="secondary-btn" type="submit" {% if not audit_pagination.has_next %}disabled{% endif %}>下一页</button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="empty-state">暂无符合条件的审计记录。</div>
    {% endif %}
</section>
{% endblock %}
