{% extends "admin/layout.html" %}
{% set active_page = "users" %}
{% set page_title = "用户详情" %}
{% set page_subtitle = "管理账号信息、关联卡密与安全操作。" %}

{% block title %}用户详情 - 授权管理后台{% endblock %}

{% block head_extra %}
<style>
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
    }
    .summary-card {
        border-radius: 18px;
        padding: 18px 20px;
        background: var(--bg-panel-alt);
        border: 1px solid rgba(37, 99, 235, 0.14);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
        display: grid;
        gap: 6px;
    }
    .summary-title {
        text-transform: uppercase;
        font-size: 12px;
        color: var(--text-secondary);
        letter-spacing: 0.05em;
    }
    .summary-value {
        font-size: 24px;
        font-weight: 700;
        word-break: break-all;
    }
    .summary-sub {
        font-size: 12px;
        color: var(--text-secondary);
    }
    .summary-link {
        color: var(--brand-dark);
        font-weight: 600;
        text-decoration: none;
    }
    .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 18px;
        border-radius: 999px;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.05));
        color: var(--brand-dark);
        font-weight: 600;
        font-size: 13px;
    }
    .status-chip.neutral {
        background: linear-gradient(135deg, rgba(107, 114, 128, 0.12), rgba(148, 163, 184, 0.08));
        color: var(--text-secondary);
    }
    .user-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 18px 20px;
    }
    .user-info-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .user-info-label {
        text-transform: uppercase;
        font-size: 12px;
        color: var(--text-secondary);
        letter-spacing: 0.05em;
    }
    .user-info-value {
        font-weight: 600;
        font-size: 15px;
    }
    .form-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    .danger-zone {
        border: 1px dashed rgba(239, 68, 68, 0.35);
        border-radius: 18px;
        padding: 20px;
        background: rgba(254, 226, 226, 0.6);
        display: grid;
        gap: 14px;
    }
    .timeline {
        display: grid;
        gap: 16px;
    }
    .timeline-item {
        border-left: 3px solid rgba(37, 99, 235, 0.25);
        padding: 12px 18px;
        background: rgba(248, 250, 252, 0.9);
        border-radius: 16px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }
    .timeline-title {
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 14px;
    }
    .timeline-time {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-secondary);
        letter-spacing: 0.05em;
    }
    .user-table-hint {
        font-size: 13px;
        color: var(--text-secondary);
    }
    @media (max-width: 1080px) {
        .summary-value {
            font-size: 20px;
        }
    }
</style>
{% endblock %}

{% block topbar_actions %}
<a class="secondary-btn" href="/admin/users">返回用户列表</a>
{% if license %}
<div class="status-chip">
    <span>卡密状态</span>
    <strong>{{ status_labels.get(license.status, license.status) }}</strong>
</div>
{% else %}
<div class="status-chip neutral">未绑定卡密</div>
{% endif %}
{% endblock %}

{% block content %}
{% set return_to = return_to | default(request.url.path + ('?' + request.url.query if request.url.query else '')) %}
{% set current_slot_code = license.software_slot.code if license and license.software_slot else '' %}

<section class="summary-grid">
    <div class="summary-card">
        <div class="summary-title">用户名</div>
        <span class="summary-value">{{ user_obj.username }}</span>
        <div class="summary-sub">用户编号 #{{ user_obj.id }}</div>
    </div>
    <div class="summary-card">
        <div class="summary-title">关联卡密</div>
        {% if license %}
        <a class="summary-link" href="/admin/licenses/{{ license.card_code }}">{{ license.card_code }}</a>
        <div class="summary-sub">状态：{{ status_labels.get(license.status, license.status) }}</div>
        {% else %}
        <span class="summary-value">未绑定</span>
        {% endif %}
    </div>
    <div class="summary-card">
        <div class="summary-title">软件位</div>
        {% if license and license.software_slot %}
        <span class="summary-value">{{ license.software_slot.name or license.software_slot.code }}</span>
        <div class="summary-sub">标识：{{ license.software_slot.code }}</div>
        {% else %}
        <span class="summary-value">未绑定</span>
        {% endif %}
    </div>
    <div class="summary-card">
        <div class="summary-title">注册时间</div>
        <span class="summary-value">{{ user_obj.created_at.isoformat() }}</span>
    </div>
    <div class="summary-card">
        <div class="summary-title">激活设备</div>
        <span class="summary-value">{{ activations|length if activations else 0 }}</span>
        {% if latest_seen %}
        <div class="summary-sub">最近心跳：{{ latest_seen.isoformat() }}</div>
        {% endif %}
    </div>
</section>

<div class="grid-two-columns">
    <section class="panel">
        <div>
            <h2>账户信息</h2>
            <div class="user-info-grid">
                <div class="user-info-item">
                    <span class="user-info-label">用户名</span>
                    <span class="user-info-value">{{ user_obj.username }}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">注册时间</span>
                    <span class="user-info-value">{{ user_obj.created_at.isoformat() }}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">绑定卡密</span>
                    <span class="user-info-value">{{ license.card_code if license else '-' }}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">卡密状态</span>
                    <span class="user-info-value">{{ status_labels.get(license.status, license.status) if license else '未绑定' }}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">软件位</span>
                    {% if license and license.software_slot %}
                    <span class="user-info-value">{{ license.software_slot.name or license.software_slot.code }}</span>
                    <div class="summary-sub">标识：{{ license.software_slot.code }}</div>
                    {% else %}
                    <span class="user-info-value">-</span>
                    {% endif %}
                </div>
                {% if license and license.expire_at %}
                <div class="user-info-item">
                    <span class="user-info-label">卡密到期</span>
                    <span class="user-info-value">{{ license.expire_at.isoformat() }}</span>
                </div>
                {% endif %}
                {% if expires_in_days is not none %}
                <div class="user-info-item">
                    <span class="user-info-label">剩余天数</span>
                    <span class="user-info-value">{{ expires_in_days }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <div>
            <h2>快速更新</h2>
            <form method="post" action="/admin/users/{{ user_obj.id }}/profile">
                <div>
                    <label class="user-info-label" for="profile-username">新的用户名</label>
                    <input id="profile-username" type="text" name="username" placeholder="保持不变请留空" />
                </div>
                <div>
                    <label class="user-info-label" for="profile-card">重新绑定卡密</label>
                    <input id="profile-card" type="text" name="card_code" placeholder="输入卡密编号" />
                </div>
                <div>
                    <label class="user-info-label" for="profile-slot">软件位</label>
                    {% if software_slots %}
                    <select id="profile-slot" name="slot_code">
                        <option value="">保持不变 / 自动匹配</option>
                        {% for slot in software_slots %}
                        <option value="{{ slot.code }}" {% if current_slot_code and slot.code == current_slot_code %}selected{% endif %}>
                            {{ slot.name or slot.code }}（{{ slot.code }}）
                        </option>
                        {% endfor %}
                    </select>
                    <div class="user-table-hint">重新绑定卡密时请选择对应的软件位</div>
                    {% else %}
                    <select id="profile-slot" name="slot_code" disabled>
                        <option value="">暂无软件位，请先创建</option>
                    </select>
                    {% endif %}
                </div>
                <input type="hidden" name="return_to" value="{{ return_to }}" />
                <div class="form-actions">
                    <button class="primary-btn" type="submit">保存修改</button>
                    {% if license %}
                    <a class="secondary-btn" href="/admin/licenses/{{ license.card_code }}">查看关联卡密</a>
                    {% endif %}
                </div>
            </form>
        </div>

        <div>
            <h2>安全设置</h2>
            <form method="post" action="/admin/users/{{ user_obj.id }}/password">
                <div>
                    <label class="user-info-label" for="password-new">新密码</label>
                    <input id="password-new" type="password" name="password" minlength="8" placeholder="至少 8 位" required />
                </div>
                <div>
                    <label class="user-info-label" for="password-confirm">确认新密码</label>
                    <input id="password-confirm" type="password" name="confirm_password" minlength="8" placeholder="再次输入" required />
                </div>
                <input type="hidden" name="return_to" value="{{ return_to }}" />
                <button class="primary-btn" type="submit">更新密码</button>
            </form>
        </div>

        <div class="danger-zone">
            <div style="font-weight:600;">危险操作</div>
            <div style="color: var(--danger); font-size: 13px;">删除用户将解绑卡密并清空相关激活记录，操作不可恢复。</div>
            <form method="post" action="/admin/users/{{ user_obj.id }}/delete" onsubmit="return confirm('确认删除该用户并解绑卡密吗？');">
                <input type="hidden" name="return_to" value="/admin/users" />
                <button class="danger-btn" type="submit">删除用户</button>
            </form>
        </div>
    </section>

    <section class="panel">
        <div>
            <h2>卡密概览</h2>
            {% if license %}
            <div class="user-info-grid">
                <div class="user-info-item">
                    <span class="user-info-label">卡密编号</span>
                    <span class="user-info-value">{{ license.card_code }}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">绑定指纹</span>
                    <span class="user-info-value">{{ license.bound_fingerprint or '-' }}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">软件位</span>
                    {% if license.software_slot %}
                    <span class="user-info-value">{{ license.software_slot.name or license.software_slot.code }}</span>
                    <div class="summary-sub">标识：{{ license.software_slot.code }}</div>
                    {% else %}
                    <span class="user-info-value">-</span>
                    {% endif %}
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">创建时间</span>
                    <span class="user-info-value">{{ license.created_at.isoformat() }}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">更新时间</span>
                    <span class="user-info-value">{{ license.updated_at.isoformat() }}</span>
                </div>
            </div>
            {% else %}
            <div class="empty-state">该用户暂未绑定卡密，可通过上方表单重新绑定。</div>
            {% endif %}
        </div>

        <div>
            <h2>激活设备</h2>
            {% if activations %}
            <table>
                <thead>
                    <tr>
                        <th>设备指纹</th>
                        <th>Token</th>
                        <th>首次激活</th>
                        <th>最近心跳</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activation in activations %}
                    <tr>
                        <td>{{ activation.device_fingerprint }}</td>
                        <td>{{ activation.token or '-' }}</td>
                        <td>{{ activation.activated_at.isoformat() }}</td>
                        <td>{{ activation.last_seen.isoformat() if activation.last_seen else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">暂无激活记录。</div>
            {% endif %}
        </div>

        <div>
            <h2>审计日志（最近 50 条）</h2>
            {% if audit_logs %}
            <div class="timeline">
                {% for log in audit_logs %}
                <div class="timeline-item">
                    <div class="timeline-title">{{ log.event_type }}</div>
                    <div>{{ log.message or '-' }}</div>
                    <div class="timeline-time">{{ log.created_at.isoformat() }}</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">暂无审计记录。</div>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}
